// FTC Metrics v2 Database Schema
// DECODE 2025-2026 Season

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// USER & AUTHENTICATION (NextAuth.js v5 compatible)
// ============================================================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime? @map("email_verified")
  image         String?
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // NextAuth relations
  accounts Account[]
  sessions Session[]

  // App relations
  teamMemberships TeamMember[]
  scoutingEntries ScoutingEntry[]
  scoutingNotes   ScoutingNote[]
  createdInvites  TeamInvite[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// ============================================================================
// TEAMS
// ============================================================================

model Team {
  id             String       @id @default(cuid())
  teamNumber     Int          @unique @map("team_number")
  name           String
  sharingLevel   SharingLevel @default(PRIVATE) @map("sharing_level")
  bio            String?      @db.Text
  robotName      String?      @map("robot_name")
  robotDesc      String?      @map("robot_desc") @db.Text
  drivetrainType String?      @map("drivetrain_type")
  links          Json?        // Array<{title: string, url: string}>
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  // Relations
  members         TeamMember[]
  invites         TeamInvite[]
  media           TeamMedia[]
  scoutingEntries ScoutingEntry[] @relation("ScoutingTeam")
  scoutedEntries  ScoutingEntry[] @relation("ScoutedTeam")
  scoutingNotes   ScoutingNote[]  @relation("NotingTeam")
  notesAbout      ScoutingNote[]  @relation("NotedTeam")

  @@map("teams")
}

enum SharingLevel {
  PRIVATE // Only team members can see
  EVENT   // Teams at the same event can see
  PUBLIC  // Everyone can see
}

model TeamMember {
  id       String   @id @default(cuid())
  userId   String   @map("user_id")
  teamId   String   @map("team_id")
  role     TeamRole @default(STUDENT)
  joinedAt DateTime @default(now()) @map("joined_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([userId, teamId])
  @@index([teamId])
  @@index([userId])
  @@map("team_members")
}

enum TeamRole {
  MENTOR
  LEADER
  STUDENT
  FRIEND
}

model TeamInvite {
  id        String   @id @default(cuid())
  teamId    String   @map("team_id")
  code      String   @unique
  createdBy String   @map("created_by")
  maxUses   Int?
  uses      Int      @default(0)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  team    Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  creator User @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@map("team_invites")
}

model TeamMedia {
  id          String    @id @default(cuid())
  teamId      String    @map("team_id")
  type        MediaType
  title       String
  url         String
  description String?   @db.Text
  fileSize    Int?      @map("file_size")
  mimeType    String?   @map("mime_type")
  isUpload    Boolean   @default(false) @map("is_upload")
  sortOrder   Int       @default(0) @map("sort_order")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId, type])
  @@map("team_media")
}

enum MediaType {
  CAD
  VIDEO
  PHOTO
  LINK
}

// ============================================================================
// FTC EVENTS & MATCHES (from FTC Events API)
// ============================================================================

model Event {
  id        String   @id @default(cuid())
  eventCode String   @unique @map("event_code")
  season    Int      // 2025 for DECODE
  name      String
  startDate DateTime @map("start_date")
  endDate   DateTime @map("end_date")
  venue     String?
  city      String?
  stateProv String?  @map("state_prov")
  country   String?
  timezone  String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  matches         Match[]
  scoutingEntries ScoutingEntry[]
  scoutingNotes   ScoutingNote[]

  @@map("events")
}

model Match {
  id              String      @id @default(cuid())
  eventCode       String      @map("event_code")
  matchNumber     Int         @map("match_number")
  tournamentLevel String      @map("tournament_level") // QUALIFICATION, SEMIFINAL, FINAL
  red1            Int         // Team number
  red2            Int
  blue1           Int
  blue2           Int
  redScore        Int?        @map("red_score")
  blueScore       Int?        @map("blue_score")
  scoreDetails    Json?       @map("score_details") // Full breakdown from API
  scheduledTime   DateTime?   @map("scheduled_time")
  actualTime      DateTime?   @map("actual_time")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  event           Event       @relation(fields: [eventCode], references: [eventCode], onDelete: Cascade)
  scoutingEntries ScoutingEntry[]

  @@unique([eventCode, tournamentLevel, matchNumber])
  @@index([eventCode])
  @@index([red1])
  @@index([red2])
  @@index([blue1])
  @@index([blue2])
  @@map("matches")
}

// ============================================================================
// SCOUTING DATA (DECODE-specific)
// ============================================================================

model ScoutingEntry {
  id        String   @id @default(cuid())

  // Who scouted and who was scouted
  scouterId     String?  @map("scouter_id")
  scoutingTeamId String @map("scouting_team_id")
  scoutedTeamId String  @map("scouted_team_id")

  // Match context
  eventCode   String  @map("event_code")
  matchId     String? @map("match_id")
  matchNumber Int     @map("match_number")
  alliance    String  // RED or BLUE

  // ==================
  // AUTONOMOUS SCORING
  // ==================
  autoLeave             Boolean @default(false) @map("auto_leave")              // 3 pts
  autoClassifiedCount   Int     @default(0) @map("auto_classified_count")       // 3 pts each
  autoOverflowCount     Int     @default(0) @map("auto_overflow_count")         // 1 pt each
  autoPatternCount      Int     @default(0) @map("auto_pattern_count")          // 2 pts each

  // ==================
  // TELEOP SCORING
  // ==================
  teleopClassifiedCount Int     @default(0) @map("teleop_classified_count")     // 3 pts each
  teleopOverflowCount   Int     @default(0) @map("teleop_overflow_count")       // 1 pt each
  teleopDepotCount      Int     @default(0) @map("teleop_depot_count")          // 1 pt each
  teleopPatternCount    Int     @default(0) @map("teleop_pattern_count")        // 2 pts each
  teleopMotifCount      Int     @default(0) @map("teleop_motif_count")          // 2 pts each

  // ==================
  // ENDGAME SCORING
  // ==================
  endgameBaseStatus     EndgameBase @default(NONE) @map("endgame_base_status")  // NONE, PARTIAL (5), FULL (10)

  // ==================
  // NOTES
  // ==================
  allianceNotes         String? @map("alliance_notes")

  // ==================
  // COMPUTED SCORES
  // ==================
  autoScore     Int @default(0) @map("auto_score")
  teleopScore   Int @default(0) @map("teleop_score")
  endgameScore  Int @default(0) @map("endgame_score")
  totalScore    Int @default(0) @map("total_score")

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  scouter      User?  @relation(fields: [scouterId], references: [id], onDelete: SetNull)
  scoutingTeam Team   @relation("ScoutingTeam", fields: [scoutingTeamId], references: [id], onDelete: Cascade)
  scoutedTeam  Team   @relation("ScoutedTeam", fields: [scoutedTeamId], references: [id], onDelete: Cascade)
  event        Event  @relation(fields: [eventCode], references: [eventCode], onDelete: Cascade)
  match        Match? @relation(fields: [matchId], references: [id], onDelete: SetNull)

  // Indexes for common queries
  @@index([eventCode])
  @@index([scoutedTeamId])
  @@index([scoutingTeamId])
  @@index([scouterId])
  @@index([eventCode, scoutedTeamId])
  @@unique([scouterId, eventCode, matchNumber, scoutedTeamId])
  @@index([createdAt])
  @@map("scouting_entries")
}

enum EndgameBase {
  NONE    // 0 pts
  PARTIAL // 5 pts
  FULL    // 10 pts
}

// ============================================================================
// QUALITATIVE SCOUTING NOTES
// ============================================================================

model ScoutingNote {
  id String @id @default(cuid())

  // Who noted and about whom
  authorId       String? @map("author_id")
  notingTeamId   String @map("noting_team_id")
  aboutTeamId    String @map("about_team_id")

  // Context (optional)
  eventCode String? @map("event_code")

  // Qualitative ratings (1-5 scale)
  reliabilityRating Int? @map("reliability_rating") // Robot reliability
  driverSkillRating Int? @map("driver_skill_rating")
  defenseRating     Int? @map("defense_rating")

  // Free-form notes
  strategyNotes   String? @map("strategy_notes")
  mechanicalNotes String? @map("mechanical_notes")
  generalNotes    String? @map("general_notes")

  // Metadata
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  author     User?  @relation(fields: [authorId], references: [id], onDelete: SetNull)
  notingTeam Team   @relation("NotingTeam", fields: [notingTeamId], references: [id], onDelete: Cascade)
  aboutTeam  Team   @relation("NotedTeam", fields: [aboutTeamId], references: [id], onDelete: Cascade)
  event      Event? @relation(fields: [eventCode], references: [eventCode], onDelete: SetNull)

  // Indexes for common queries
  @@index([aboutTeamId])
  @@index([notingTeamId])
  @@index([eventCode])
  @@unique([authorId, aboutTeamId, notingTeamId, eventCode])
  @@index([createdAt])
  @@map("scouting_notes")
}

// ============================================================================
// FTC TEAM CACHE (populated from FTC Events API)
// ============================================================================

model FtcTeam {
  id          String   @id @default(cuid())
  teamNumber  Int      @unique @map("team_number")
  nameShort   String   @map("name_short")
  nameFull    String   @map("name_full")
  city        String?
  stateProv   String?  @map("state_prov")
  country     String?
  rookieYear  Int?     @map("rookie_year")
  fetchedAt   DateTime @default(now()) @map("fetched_at")

  events FtcTeamEvent[]

  @@index([nameShort])
  @@index([nameFull])
  @@map("ftc_teams")
}

model FtcTeamEvent {
  id          String   @id @default(cuid())
  teamNumber  Int      @map("team_number")
  eventCode   String   @map("event_code")
  eventName   String   @map("event_name")
  city        String?
  stateProv   String?  @map("state_prov")
  dateStart   DateTime @map("date_start")
  rank        Int?
  wins        Int?
  losses      Int?
  ties        Int?
  qualAverage Float?   @map("qual_average")
  fetchedAt   DateTime @default(now()) @map("fetched_at")

  team FtcTeam @relation(fields: [teamNumber], references: [teamNumber], onDelete: Cascade)

  @@unique([teamNumber, eventCode])
  @@index([eventCode])
  @@map("ftc_team_events")
}

// ============================================================================
// ANALYTICS
// ============================================================================

model EPAHistory {
  id         String   @id @default(cuid())
  teamNumber Int      @map("team_number")
  eventCode  String   @map("event_code")
  matchNumber Int     @map("match_number")
  epaValue   Float    @map("epa_value")
  recordedAt DateTime @default(now()) @map("recorded_at")

  @@index([teamNumber])
  @@index([eventCode])
  @@map("epa_history")
}
